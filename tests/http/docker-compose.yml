#==========================================================================================================
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Vinny Parla
# File: tests/http/docker-compose.yml
# Purpose: Two-container e2e (server + client tests) for HTTP(S) transport (TLS 1.3 only)
#==========================================================================================================

name: mcp-http-e2e

services:
  http-server:
    image: mcp-http:latest
    container_name: http-server
    command: ["/usr/local/bin/http_server_bin"]
    healthcheck:
      # Perform a minimal HTTPS POST to /mcp/rpc so the server sees a valid HTTP request
      test: ["CMD-SHELL", "timeout 5 bash -lc 'printf \"POST /mcp/rpc HTTP/1.1\\r\\nHost: localhost\\r\\nContent-Type: application/json\\r\\nContent-Length: 2\\r\\n\\r\\n{}\" | openssl s_client -connect localhost:9443 -tls1_3 -quiet -ign_eof 2>/dev/null | head -n1 | grep -q \"HTTP/1.1\"'" ]
      interval: 3s
      timeout: 5s
      retries: 15
    expose:
      - "9443"

  http-client:
    image: mcp-http:latest
    container_name: http-client
    depends_on:
      http-server:
        condition: service_healthy
    environment:
      - MCP_HTTP_HOST=http-server
      - MCP_HTTP_PORT=9443
      - MCP_HTTP_RPC=/mcp/rpc
      - MCP_HTTP_CA=/certs/cert.pem
      - MCP_HTTP_SNI=http-mcp-server
    command: ["/usr/local/bin/http_client_tests", "--gtest_color=yes"]
